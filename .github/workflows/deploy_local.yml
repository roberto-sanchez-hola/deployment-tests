name: üöÄ Deploy local (dev)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-local:
    runs-on: ubuntu-latest
    environment: dev
    env:
      DEV_ADMIN_BDC_PASSWORD: ${{ secrets.DEV_ADMIN_BDC_PASSWORD }}
      DEV_ALL_DB_DATABASE: ${{ secrets.DEV_ALL_DB_DATABASE }}
      DEV_ROOT_APIKEY_EV: ${{ secrets.DEV_ROOT_APIKEY_EV }}
      DEV_ADMIN_DIR_APPLICATION: ${{ vars.DEV_ADMIN_DIR_APPLICATION }}
      DEV_ALL_DB_DRIVER: ${{ vars.DEV_ALL_DB_DRIVER }}
      DEV_CRM_DIR_APPLICATION: ${{ vars.DEV_CRM_DIR_APPLICATION }}
      DEV_ALL_DB_PREFIX: ${{ vars.DEV_ALL_DB_PREFIX }}

    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4
      - name: Create temporary .env FILE
        run: |
          echo "" > "$GITHUB_WORKSPACE/secrets.env"
          printenv | grep ^DEV_ >> "$GITHUB_WORKSPACE/secrets.env" || true

      - name: üõ†Ô∏è Generate config.php files
        run: |
         
          
          mkdir -p admin crm
          echo "<?php" > config.php
          echo "<?php" > admin/config.php
          echo "<?php" > crm/config.php

          while IFS='=' read -r key value; do
            [[ -z "$key" || "$key" == \#* ]] && continue
            IFS='_' read -r env context name <<< "$key"
            const="${key#${env}_${context}_}"

            case "$context" in
              ROOT)
                echo "define('${const}', '${value}');" >> config.php
                ;;
              ADMIN)
                echo "define('${const}', '${value}');" >> admin/config.php
                ;;
              CRM)
                echo "define('${const}', '${value}');" >> crm/config.php
                ;;
              ALL)
                echo "define('${const}', '${value}');" >> config.php
                echo "define('${const}', '${value}');" >> admin/config.php
                echo "define('${const}', '${value}');" >> crm/config.php
                ;;
            esac
          done < "$GITHUB_WORKSPACE/secrets.env"

      - name: üßæ Mostrar contenido de los archivos config generados
        run: |
          echo "üßæ config.php (ROOT)"
          cat config.php || echo "‚ùå No encontrado"
          echo ""
          echo "üßæ admin/config.php (ADMIN)"
          cat admin/config.php || echo "‚ùå No encontrado"
          echo ""
          echo "üßæ crm/config.php (CRM)"
          cat crm/config.php || echo "‚ùå No encontrado"
          cat $GITHUB_WORKSPACE/secrets.env

      - name: üìÇ Verifica contenido antes de subir
        run: |
          echo "Contenido de secrets.env:"
          cat $GITHUB_WORKSPACE/secrets.env || echo "‚ùå secrets.env no existe"

          echo "Archivos disponibles:"
          ls -l

      - name: üì§ Subir secrets.env como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: deploy-outputs
          path: .